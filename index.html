<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文都云图：南京现当代文学地图数字导览与文创平台</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/ai_assistant.css"> 
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
       .explore-btn-container {
            text-align: center;
            padding: 40px 0; 
            margin-top: 20px;
            background: linear-gradient(135deg, #1a5fad, #2a8fe6, #c2e5ff);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.1) 20%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.1) 15%, transparent 30%);
            box-shadow: 0 4px 15px rgba(0, 100, 200, 0.3); 
        }

        .explore-btn {
            background: linear-gradient(to right, #2a6fc7, #4a9df7);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3); 
            transition: all 0.3s; 
            font-size: 1.6rem;
        }
        .explore-btn:hover {
            background: linear-gradient(to right, #1a5fad, #3a8de0); 
            transform: translateY(-2px); 
        }
                
                @media (max-width: 768px) {
                    .explore-btn {
                        padding: 12px 30px;
                        font-size: 1.4rem;
                    }
                }
    </style>
</head>
<body>
    <div class="header">
        <h1>探索作家笔下的人文南京</h1>
        <p>文都云图：南京现当代文学地图数字导览与文创平台</p>
    </div>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="请输入作家姓名(如:叶兆言、朱自清...)">
        <button id="searchBtn">搜索</button>
    </div>
    
    <div class="container">
        <div id="mapContainer"></div>
        
        <div class="sidebar">
            <div id="infoPanel">
                <div class="default-message">
                    <h3>欢迎使用南京现当代文学地图数字导览与文创平台</h3>
                    <p>在搜索框中输入作家姓名，查看他们在南京的创作足迹</p>
                    <p>点击地图上的标记点，查看作品详情</p>
                </div>
            </div>
            
            <div id="counter">
                <div class="counter-label">当前展示</div>
                <div class="counter-number">0</div>
                <div class="counter-label">个相关地标</div>
            </div>
        </div>
    </div>
    
    <!-- AI助手容器保持不变 -->
    <div id="ai-assistant">
        <div id="chat-container">
            <div class="chat-header">
                <h3>南京文学助手</h3>
                <button id="close-chat">×</button>
            </div>
            <!-- 虚拟形象区域 -->
            <div id="avatar-container">
                <div id="avatar-animation"></div>
            </div>
            <div id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="user-input" placeholder="输入关于南京现当代文学的问题...">
                <button id="send-btn">发送</button>
            </div>
        </div>
        <button id="chat-toggle">💬</button>
    </div>

    
    
    <div class="explore-btn-container">
        <a href="./html/product.html" class="explore-btn">
            文创产品
        </a>
    </div>
    
    <script src="./js/script.js"></script>
    <script src="./js/ai_assistant.js"></script> 
    
    <script>
    // 地图初始化代码
    $(document).ready(function() {
        const myChart = echarts.init(document.getElementById('mapContainer'));
    
    // 使用全局函数获取标记点数据
    const allMarkers = window.getNanjingMarkers();
        // 显示加载动画
        myChart.showLoading({
            text: '正在加载南京地图数据...',
            color: '#4a6cf7',
            textColor: '#4a5568',
            maskColor: 'rgba(255, 255, 255, 0.9)'
        });
        
        // 使用本地地图数据
        fetch('./data/nanjing.json')
            .then(response => response.json())
            .then(nanjingGeoJSON => {
                // 注册南京地图
                echarts.registerMap('nanjing', nanjingGeoJSON);
                
                // 使用文档2提供的数据构建标记点
                
                const allMarkers = window.getNanjingMarkers();
                
                // 配置地图选项
                const option = {
                    title: {
                        text: '南京文学地图',
                        subtext: '作家笔下的人文南京',
                        left: 'center',
                        textStyle: { 
                            color: '#2d3748', 
                            fontSize: 24,
                            fontWeight: 'bold'
                        },
                        subtextStyle: { 
                            color: '#718096',
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 15,
                        borderRadius: 8,
                        textStyle: {
                            color: '#2d3748'
                        },
                        formatter: function(params) {
                            if (params.componentType === 'series') {
                                return `<div style="font-weight:bold;margin-bottom:5px;">${params.name}</div>
                                        <div>${params.data.excerpt || '南京文学地标'}</div>
                                        <div style="margin-top:8px;color:#4a5568;">点击查看详情</div>`;
                            }
                            return params.name;
                        }
                    },
                    geo: {
                        map: 'nanjing',
                        roam: true,
                        zoom: 8,
                        center: [118.8, 32.05],
                        label: { 
                            emphasis: { 
                                show: false 
                            } 
                        },
                        itemStyle: {
                            areaColor: '#e8f4ff',
                            borderColor: '#297acc'
                        },
                        emphasis: {
                            itemStyle: { 
                                areaColor: '#a4d0ff' 
                            },
                            label: { 
                                show: true, 
                                color: '#1a3d66' 
                            }
                        }
                    },
                    series: [{
                        name: '文学地标',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        symbol: 'pin',
                        symbolSize: [40, 50],
                        itemStyle: { 
                            color: '#ff6b6b' 
                        },
                        data: allMarkers,
                        label: {
                            show: true,
                            formatter: '{b}',
                            position: 'bottom',
                            color: '#1a3d66',
                            fontSize: 12
                        },
                        zlevel: 2
                    }]
                };
                
                // 应用配置
                myChart.setOption(option);
                
                // 隐藏加载动画
                myChart.hideLoading();
                
                // 更新计数器
                $('.counter-number').text(allMarkers.length);
                
                // 地图点击事件
                myChart.on('click', function(params) {
                    if (params.componentType === 'series') {
                        const location = params.data;
                        
                        // 生成作品列表HTML
                        let worksHtml = '';
                        if (location.works && location.works.length > 0) {
                            worksHtml = '<div class="literary-works"><h4>相关作品:</h4><ul>';
                            location.works.forEach(work => {
                                worksHtml += `<li>${work}</li>`;
                            });
                            worksHtml += '</ul></div>';
                        }
                        
                        const content = `
                            <div class="location-detail">
                                <h3>${location.name}</h3>
                                <p>${location.excerpt}</p>
                                ${worksHtml}
                            </div>
                        `;
                        
                        $('#infoPanel').html(content);
                        
                        // 高亮当前选中区域
                        myChart.dispatchAction({
                            type: 'highlight',
                            seriesIndex: 0,
                            name: location.name
                        });
                    }
                });
            })
            .catch(error => {
                console.error('加载南京地图数据失败:', error);
                myChart.hideLoading();
                myChart.setOption({
                    title: {
                        text: '数据加载失败',
                        subtext: '请检查网络连接或稍后再试',
                        left: 'center',
                        top: 'center'
                    }
                });
            });
        
        // 响应窗口大小变化
        window.addEventListener('resize', function() {
            myChart.resize();
        });
        
        // 搜索按钮点击事件
        $('#searchBtn').click(function() {
            const query = $('#searchInput').val().trim();
            
            // 先取消之前所有高亮
            myChart.dispatchAction({ type: 'downplay' });
            
            // 过滤出包含该作者的地标点
            const filteredMarkers = allMarkers.filter(marker => 
                marker.authors && marker.authors.some(author => author.includes(query))
            );
            
            if (filteredMarkers.length > 0) {
                // 更新地图数据 - 只显示该作家相关的标记点
                myChart.setOption({
                    series: [{
                        data: filteredMarkers
                    }]
                });
                
                // 更新计数器
                $('.counter-number').text(filteredMarkers.length);
                
                // 高亮相关区域
                filteredMarkers.forEach(marker => {
                    myChart.dispatchAction({
                        type: 'highlight',
                        seriesIndex: 0,
                        name: marker.name
                    });
                });
                
                // 查找作家信息
                const matchedAuthor = Object.keys(authorsData).find(author => 
                    author.includes(query) || query.includes(author)
                );
                
                if (matchedAuthor) {
                    const authorInfo = authorsData[matchedAuthor];
                    // 构建作品列表
                    let worksHtml = '';
                    if (authorInfo.works && authorInfo.works.length > 0) {
                        worksHtml = '<div class="literary-works"><h4>代表作品:</h4><ul>';
                        authorInfo.works.forEach(work => {
                            worksHtml += `<li>《${work.title}》 - ${work.location}</li>`;
                        });
                        worksHtml += '</ul></div>';
                    }
                    
                    $('#infoPanel').html(`
                        <div class="author-info">
                            <h3>${authorInfo.name}</h3>
                            <p>${authorInfo.intro}</p>
                            ${worksHtml}
                        </div>
                    `);
                }
            } else {
                $('#infoPanel').html(`<div class="author-info">
                    <h3>未找到相关结果</h3>
                    <p>请尝试搜索作家姓名(如:叶兆言、朱自清)或地点名称(如:秦淮河、夫子庙)</p>
                </div>`);
                
                myChart.setOption({
                    series: [{
                        data: allMarkers
                    }]
                });
                $('.counter-number').text(allMarkers.length);
            }
        });
    });
</script>
</body>
</html>