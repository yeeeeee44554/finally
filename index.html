<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡éƒ½äº‘å›¾ï¼šå—äº¬ç°å½“ä»£æ–‡å­¦åœ°å›¾æ•°å­—å¯¼è§ˆä¸æ–‡åˆ›å¹³å°</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/ai_assistant.css"> 
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.2/echarts.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
       .explore-btn-container {
            text-align: center;
            padding: 40px 0; 
            margin-top: 20px;
            background: linear-gradient(135deg, #1a5fad, #2a8fe6, #c2e5ff);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.1) 20%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.1) 15%, transparent 30%);
            box-shadow: 0 4px 15px rgba(0, 100, 200, 0.3); 
        }

        .explore-btn {
            background: linear-gradient(to right, #2a6fc7, #4a9df7);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3); 
            transition: all 0.3s; 
            font-size: 1.6rem;
        }
        .explore-btn:hover {
            background: linear-gradient(to right, #1a5fad, #3a8de0); 
            transform: translateY(-2px); 
        }
                
                @media (max-width: 768px) {
                    .explore-btn {
                        padding: 12px 30px;
                        font-size: 1.4rem;
                    }
                }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ¢ç´¢ä½œå®¶ç¬”ä¸‹çš„äººæ–‡å—äº¬</h1>
        <p>æ–‡éƒ½äº‘å›¾ï¼šå—äº¬ç°å½“ä»£æ–‡å­¦åœ°å›¾æ•°å­—å¯¼è§ˆä¸æ–‡åˆ›å¹³å°</p>
    </div>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥ä½œå®¶å§“å(å¦‚:å¶å…†è¨€ã€æœ±è‡ªæ¸…...)">
        <button id="searchBtn">æœç´¢</button>
    </div>
    
    <div class="container">
        <div id="mapContainer"></div>
        
        <div class="sidebar">
            <div id="infoPanel">
                <div class="default-message">
                    <h3>æ¬¢è¿ä½¿ç”¨å—äº¬ç°å½“ä»£æ–‡å­¦åœ°å›¾æ•°å­—å¯¼è§ˆä¸æ–‡åˆ›å¹³å°</h3>
                    <p>åœ¨æœç´¢æ¡†ä¸­è¾“å…¥ä½œå®¶å§“åï¼ŒæŸ¥çœ‹ä»–ä»¬åœ¨å—äº¬çš„åˆ›ä½œè¶³è¿¹</p>
                    <p>ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°ç‚¹ï¼ŒæŸ¥çœ‹ä½œå“è¯¦æƒ…</p>
                </div>
            </div>
            
            <div id="counter">
                <div class="counter-label">å½“å‰å±•ç¤º</div>
                <div class="counter-number">0</div>
                <div class="counter-label">ä¸ªç›¸å…³åœ°æ ‡</div>
            </div>
        </div>
    </div>
    
    <!-- AIåŠ©æ‰‹å®¹å™¨ä¿æŒä¸å˜ -->
    <div id="ai-assistant">
        <div id="chat-container">
            <div class="chat-header">
                <h3>å—äº¬æ–‡å­¦åŠ©æ‰‹</h3>
                <button id="close-chat">Ã—</button>
            </div>
            <!-- è™šæ‹Ÿå½¢è±¡åŒºåŸŸ -->
            <div id="avatar-container">
                <div id="avatar-animation"></div>
            </div>
            <div id="chat-messages"></div>
            <div class="chat-input">
                <input type="text" id="user-input" placeholder="è¾“å…¥å…³äºå—äº¬ç°å½“ä»£æ–‡å­¦çš„é—®é¢˜...">
                <button id="send-btn">å‘é€</button>
            </div>
        </div>
        <button id="chat-toggle">ğŸ’¬</button>
    </div>

    
    
    <div class="explore-btn-container">
        <a href="./html/product.html" class="explore-btn">
            æ–‡åˆ›äº§å“
        </a>
    </div>
    
    <script src="./js/script.js"></script>
    <script src="./js/ai_assistant.js"></script> 
    
    <script>
    // åœ°å›¾åˆå§‹åŒ–ä»£ç 
    $(document).ready(function() {
        const myChart = echarts.init(document.getElementById('mapContainer'));
    
    // ä½¿ç”¨å…¨å±€å‡½æ•°è·å–æ ‡è®°ç‚¹æ•°æ®
    const allMarkers = window.getNanjingMarkers();
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        myChart.showLoading({
            text: 'æ­£åœ¨åŠ è½½å—äº¬åœ°å›¾æ•°æ®...',
            color: '#4a6cf7',
            textColor: '#4a5568',
            maskColor: 'rgba(255, 255, 255, 0.9)'
        });
        
        // ä½¿ç”¨æœ¬åœ°åœ°å›¾æ•°æ®
        fetch('./data/nanjing.json')
            .then(response => response.json())
            .then(nanjingGeoJSON => {
                // æ³¨å†Œå—äº¬åœ°å›¾
                echarts.registerMap('nanjing', nanjingGeoJSON);
                
                // ä½¿ç”¨æ–‡æ¡£2æä¾›çš„æ•°æ®æ„å»ºæ ‡è®°ç‚¹
                
                const allMarkers = window.getNanjingMarkers();
                
                // é…ç½®åœ°å›¾é€‰é¡¹
                const option = {
                    title: {
                        text: 'å—äº¬æ–‡å­¦åœ°å›¾',
                        subtext: 'ä½œå®¶ç¬”ä¸‹çš„äººæ–‡å—äº¬',
                        left: 'center',
                        textStyle: { 
                            color: '#2d3748', 
                            fontSize: 24,
                            fontWeight: 'bold'
                        },
                        subtextStyle: { 
                            color: '#718096',
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 15,
                        borderRadius: 8,
                        textStyle: {
                            color: '#2d3748'
                        },
                        formatter: function(params) {
                            if (params.componentType === 'series') {
                                return `<div style="font-weight:bold;margin-bottom:5px;">${params.name}</div>
                                        <div>${params.data.excerpt || 'å—äº¬æ–‡å­¦åœ°æ ‡'}</div>
                                        <div style="margin-top:8px;color:#4a5568;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>`;
                            }
                            return params.name;
                        }
                    },
                    geo: {
                        map: 'nanjing',
                        roam: true,
                        zoom: 8,
                        center: [118.8, 32.05],
                        label: { 
                            emphasis: { 
                                show: false 
                            } 
                        },
                        itemStyle: {
                            areaColor: '#e8f4ff',
                            borderColor: '#297acc'
                        },
                        emphasis: {
                            itemStyle: { 
                                areaColor: '#a4d0ff' 
                            },
                            label: { 
                                show: true, 
                                color: '#1a3d66' 
                            }
                        }
                    },
                    series: [{
                        name: 'æ–‡å­¦åœ°æ ‡',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        symbol: 'pin',
                        symbolSize: [40, 50],
                        itemStyle: { 
                            color: '#ff6b6b' 
                        },
                        data: allMarkers,
                        label: {
                            show: true,
                            formatter: '{b}',
                            position: 'bottom',
                            color: '#1a3d66',
                            fontSize: 12
                        },
                        zlevel: 2
                    }]
                };
                
                // åº”ç”¨é…ç½®
                myChart.setOption(option);
                
                // éšè—åŠ è½½åŠ¨ç”»
                myChart.hideLoading();
                
                // æ›´æ–°è®¡æ•°å™¨
                $('.counter-number').text(allMarkers.length);
                
                // åœ°å›¾ç‚¹å‡»äº‹ä»¶
                myChart.on('click', function(params) {
                    if (params.componentType === 'series') {
                        const location = params.data;
                        
                        // ç”Ÿæˆä½œå“åˆ—è¡¨HTML
                        let worksHtml = '';
                        if (location.works && location.works.length > 0) {
                            worksHtml = '<div class="literary-works"><h4>ç›¸å…³ä½œå“:</h4><ul>';
                            location.works.forEach(work => {
                                worksHtml += `<li>${work}</li>`;
                            });
                            worksHtml += '</ul></div>';
                        }
                        
                        const content = `
                            <div class="location-detail">
                                <h3>${location.name}</h3>
                                <p>${location.excerpt}</p>
                                ${worksHtml}
                            </div>
                        `;
                        
                        $('#infoPanel').html(content);
                        
                        // é«˜äº®å½“å‰é€‰ä¸­åŒºåŸŸ
                        myChart.dispatchAction({
                            type: 'highlight',
                            seriesIndex: 0,
                            name: location.name
                        });
                    }
                });
            })
            .catch(error => {
                console.error('åŠ è½½å—äº¬åœ°å›¾æ•°æ®å¤±è´¥:', error);
                myChart.hideLoading();
                myChart.setOption({
                    title: {
                        text: 'æ•°æ®åŠ è½½å¤±è´¥',
                        subtext: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•',
                        left: 'center',
                        top: 'center'
                    }
                });
            });
        
        // å“åº”çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', function() {
            myChart.resize();
        });
        
        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#searchBtn').click(function() {
            const query = $('#searchInput').val().trim();
            
            // å…ˆå–æ¶ˆä¹‹å‰æ‰€æœ‰é«˜äº®
            myChart.dispatchAction({ type: 'downplay' });
            
            // è¿‡æ»¤å‡ºåŒ…å«è¯¥ä½œè€…çš„åœ°æ ‡ç‚¹
            const filteredMarkers = allMarkers.filter(marker => 
                marker.authors && marker.authors.some(author => author.includes(query))
            );
            
            if (filteredMarkers.length > 0) {
                // æ›´æ–°åœ°å›¾æ•°æ® - åªæ˜¾ç¤ºè¯¥ä½œå®¶ç›¸å…³çš„æ ‡è®°ç‚¹
                myChart.setOption({
                    series: [{
                        data: filteredMarkers
                    }]
                });
                
                // æ›´æ–°è®¡æ•°å™¨
                $('.counter-number').text(filteredMarkers.length);
                
                // é«˜äº®ç›¸å…³åŒºåŸŸ
                filteredMarkers.forEach(marker => {
                    myChart.dispatchAction({
                        type: 'highlight',
                        seriesIndex: 0,
                        name: marker.name
                    });
                });
                
                // æŸ¥æ‰¾ä½œå®¶ä¿¡æ¯
                const matchedAuthor = Object.keys(authorsData).find(author => 
                    author.includes(query) || query.includes(author)
                );
                
                if (matchedAuthor) {
                    const authorInfo = authorsData[matchedAuthor];
                    // æ„å»ºä½œå“åˆ—è¡¨
                    let worksHtml = '';
                    if (authorInfo.works && authorInfo.works.length > 0) {
                        worksHtml = '<div class="literary-works"><h4>ä»£è¡¨ä½œå“:</h4><ul>';
                        authorInfo.works.forEach(work => {
                            worksHtml += `<li>ã€Š${work.title}ã€‹ - ${work.location}</li>`;
                        });
                        worksHtml += '</ul></div>';
                    }
                    
                    $('#infoPanel').html(`
                        <div class="author-info">
                            <h3>${authorInfo.name}</h3>
                            <p>${authorInfo.intro}</p>
                            ${worksHtml}
                        </div>
                    `);
                }
            } else {
                $('#infoPanel').html(`<div class="author-info">
                    <h3>æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</h3>
                    <p>è¯·å°è¯•æœç´¢ä½œå®¶å§“å(å¦‚:å¶å…†è¨€ã€æœ±è‡ªæ¸…)æˆ–åœ°ç‚¹åç§°(å¦‚:ç§¦æ·®æ²³ã€å¤«å­åº™)</p>
                </div>`);
                
                myChart.setOption({
                    series: [{
                        data: allMarkers
                    }]
                });
                $('.counter-number').text(allMarkers.length);
            }
        });
    });
</script>
</body>
</html>